<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Ring Try-on</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    #ar-button, #style-buttons { position: absolute; top: 10px; z-index: 100; display: flex; gap: 10px; }
    #ar-button { left: 10px; }
    #style-buttons { right: 10px; }
    video { display: none; }
  </style>
</head>
<body>
  <button id="ar-button">Enter AR</button>
  <div id="style-buttons">
    <button onclick="changeRingStyle('gold')">Gold</button>
    <button onclick="changeRingStyle('silver')">Silver</button>
    <button onclick="changeRingStyle('diamond')">Diamond</button>
  </div>
  <a-scene embedded arjs='sourceType: webcam;'>
    <a-marker preset="hiro">
      <a-entity id="ring" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: gold;"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    document.getElementById('ar-button').addEventListener('click', () => {
      document.querySelector('a-scene').enterVR();
    });

    const video = document.createElement('video');
    video.setAttribute('autoplay', '');
    video.setAttribute('muted', '');
    video.setAttribute('playsinline', '');
    document.body.appendChild(video);

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      return new Promise(resolve => {
        video.onloadedmetadata = () => {
          resolve(video);
        };
      });
    }

    async function detectHand() {
      const model = await handPoseDetection.load(
        handPoseDetection.SupportedModels.MediaPipeHands,
        { runtime: 'mediapipe', modelType: 'full' }
      );

      setupCamera().then(video => {
        video.play();
        const detect = async () => {
          const predictions = await model.estimateHands(video);
          if (predictions.length > 0) {
            const keypoints = predictions[0].keypoints;
            // 取得手指位置，更新戒指位置
            const ring = document.querySelector('#ring');
            ring.object3D.position.set(
              (keypoints[8].x - video.videoWidth / 2) / video.videoWidth,
              -(keypoints[8].y - video.videoHeight / 2) / video.videoHeight,
              -0.5  // 假設一個固定的深度值
            );
          }
          requestAnimationFrame(detect);
        };
        detect();
      });
    }

    function changeRingStyle(style) {
      const ring = document.querySelector('#ring');
      switch (style) {
        case 'gold':
          ring.setAttribute('geometry', 'primitive: ring; radiusInner: 0.02; radiusOuter: 0.03');
          ring.setAttribute('material', 'color: gold');
          break;
        case 'silver':
          ring.setAttribute('geometry', 'primitive: ring; radiusInner: 0.02; radiusOuter: 0.03');
          ring.setAttribute('material', 'color: silver');
          break;
        case 'diamond':
          ring.setAttribute('geometry', 'primitive: box; depth: 0.02; height: 0.02; width: 0.02');
          ring.setAttribute('material', 'color: white');
          break;
      }
    }

    detectHand();
  </script>
</body>
</html>
