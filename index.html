<!DOCTYPE html>
<html>
  <head>
    <title>Web AR Ring</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@0.0.2/dist/hand-pose-detection.min.js"></script>
  </head>
  <body>
    <a-scene vr-mode-ui="enabled: false" embedded arjs>
      <a-assets>
        <a-asset-item 
          id="ringModel" 
          src="assets/asset.glb"
          >
        </a-asset-item>
      </a-assets>

      <a-entity 
        id="ring" 
        gltf-model="#ringModel" 
        scale="0.1 0.1 0.1" 
        position="0 0 -1"
        >
      </a-entity>
      <a-camera></a-camera>
    </a-scene>

    <script>
      // 初始化手部偵測模型
      let model, video;
      const ringEntity = document.getElementById('ring');

      async function init() {
        model = await handPoseDetection.load(handPoseDetection.SupportedModels.MediaPipeHands);
        video = await setupCamera();
        video.play();
        detectHands();
      }

      async function setupCamera() {
        const video = document.createElement('video');
        video.setAttribute('autoplay', '');
        video.setAttribute('playsinline', '');
        video.setAttribute('muted', '');
        video.setAttribute('width', '640');
        video.setAttribute('height', '480');

        document.body.appendChild(video);

        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            resolve(video);
          };
        });
      }

      async function detectHands() {
        const predictions = await model.estimateHands(video);

        if (predictions.length > 0) {
          // 偵測到手部
          const hand = predictions[0];
          const middleFinger = hand.keypoints.find(point => point.name === 'middle_finger_tip');

          if (middleFinger) {
            ringEntity.setAttribute('position', `${middleFinger.x / 100 - 3.2} ${3 - middleFinger.y / 100} -5`);
          }
        } else {
          // 未偵測到手部，旋轉戒指模型
          ringEntity.object3D.rotation.y += 0.01;
        }

        requestAnimationFrame(detectHands);
      }

      init();
    </script>
  </body>
</html>
