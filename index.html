<!doctype html>
<html>
<head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        id="scene"
        embedded
        gesture-detector
    >
        <a-assets>
            <a-asset-item
                id="animated-asset"
                src="assets/asset.glb"
            ></a-asset-item>
        </a-assets>

        <a-entity
            id="ring-model"
            scale="0.5 0.5 0.5"
            position="0 0 -1"
            rotation="0 0 0"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
            gltf-model="#animated-asset"
        ></a-entity>

        <a-light type="ambient" color="#fff"></a-light>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const ringModel = document.getElementById('ring-model');
        let handDetector;

        async function setupHandTracking() {
            handDetector = await handPoseDetection.createDetector(handPoseDetection.SupportedModels.MediaPipeHands);
            detectHands();
        }

        async function detectHands() {
            const video = document.querySelector('video');
            const hands = await handDetector.estimateHands(video);

            if (hands.length > 0) {
                const hand = hands[0];
                const middleFinger = hand.keypoints.find(point => point.name === 'middle_finger_tip');

                if (middleFinger) {
                    const { x, y, z } = middleFinger;
                    ringModel.setAttribute('position', {
                        x: (x / window.innerWidth) * 2 - 1,
                        y: -(y / window.innerHeight) * 2 + 1,
                        z: -1
                    });
                    ringModel.removeAttribute('animation');
                }
            } else {
                ringModel.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000');
            }

            requestAnimationFrame(detectHands);
        }

        setupHandTracking();
    </script>
</body>
</html>
